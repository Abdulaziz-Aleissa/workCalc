<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Work Time Calculator ‚Äî Sun‚ÜíThu</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Cyber fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&family=Share+Tech+Mono&family=Audiowide&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#0f172a; --card:#111827; --muted:#94a3b8;
      --accent:#22c55e; --warn:#f59e0b; --error:#ef4444; --text:#e5e7eb;
      --select-bg:#0b1220; --select-text:#e5e7eb; --select-border:#444;
      --font:'Roboto', sans-serif;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .card {
      background: var(--card);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.4s ease forwards;
    }
    .card-header {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    /* Allow header content to wrap nicely so buttons never overflow card */
    .card-header.d-flex {
      flex-wrap: wrap;
      row-gap: 0.5rem;
    }
    .card-header .btn-group {
      flex-shrink: 0;
    }

    .form-select {
      background: var(--select-bg);
      color: var(--select-text);
      border: 1px solid var(--select-border);
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    .pill {
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--muted);
      color: var(--muted);
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
      white-space: nowrap; /* prevent text wrapping inside pills */
    }
    .good {
      color: var(--accent);
      border-color: var(--accent);
    }
    .warn {
      color: var(--warn);
      border-color: var(--warn);
    }
    .bad  {
      color: var(--error);
      border-color: var(--error);
    }
    .pill-bump {
      animation: pillBump 0.25s ease;
    }

    .progress {
      background-color: rgba(148,163,184,0.25);
      transition: background-color 0.3s ease;
      position: relative;
      overflow: visible;
    }
    .progress-bar {
      background-color: var(--accent);
      transition: width 0.3s ease, background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
    }

    .progress-firework {
      animation: progressPulse 0.45s ease-out;
      box-shadow: 0 0 10px rgba(34,197,94,0.5);
    }

    .day-toggle.btn-link {
      color: inherit;
      text-decoration: none;
      padding-left: 0;
      padding-right: 0;
      white-space: nowrap; /* keep day title one line */
    }
    .day-toggle.btn-link:hover {
      text-decoration: underline;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @keyframes pillBump {
      0%   { transform: scale(1); }
      50%  { transform: scale(1.08); }
      100% { transform: scale(1); }
    }

    @keyframes progressPulse {
      0%   { transform: scaleX(1);   box-shadow: 0 0 0 rgba(34,197,94,0); }
      50%  { transform: scaleX(1.06); box-shadow: 0 0 14px rgba(34,197,94,0.8); }
      100% { transform: scaleX(1);   box-shadow: 0 0 0 rgba(34,197,94,0); }
    }

    /* Hint box styling */
    .hint-box {
      margin-top: 0.35rem;
      padding: 0.55rem 0.75rem;
      border-radius: 0.75rem;
      background: rgba(148,163,184,0.08);
      border: 1px solid rgba(148,163,184,0.25);
      font-size: 0.8rem;
    }
    .hint-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 0.35rem;
    }
    .hint-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.1rem;
    }
    .hint-label {
      color: var(--muted);
    }
    .hint-value {
      font-weight: 500;
    }
    .hint-value-strong {
      font-weight: 600;
    }
    .hint-subtle {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 0.25rem;
    }

    /* Theme-aware outline button */
    .theme-btn {
      border-color: var(--accent) !important;
      color: var(--accent) !important;
      background-color: transparent !important;
    }
    .theme-btn:hover,
    .theme-btn:focus {
      background-color: var(--accent) !important;
      color: var(--bg) !important;
      border-color: var(--accent) !important;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.35);
    }

    /* Make ALL buttons single-line */
    .btn {
      white-space: nowrap;
    }

    /* Floating gear settings button (top-right) */
    .floating-settings {
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 1080;
      border-radius: 999px;
      padding-inline: 10px;
      padding-block: 6px;
      backdrop-filter: blur(10px);
      
      white-space: nowrap;
    }

    @media (max-width: 576px) {
      .floating-settings {
        top: 10px;
        right: 10px;
      }
    }

    /* === FULL PAGE FIREWORK OVERLAY === */
    #fireworkOverlay {
      pointer-events: none;
      position: fixed;
      inset: 0;
      z-index: 1075;
      opacity: 0;
    }

    #fireworkOverlay.show {
      animation: fireworkOverlayFade 0.8s ease-out forwards;
    }

    #fireworkOverlay::before,
    #fireworkOverlay::after {
      content: "";
      position: absolute;
      width: 220px;
      height: 220px;
      border-radius: 50%;
      background:
        radial-gradient(circle, rgba(255,255,255,0.9) 0, rgba(255,255,255,0) 55%),
        radial-gradient(circle at 20% 20%, rgba(34,197,94,0.9) 0, transparent 60%),
        radial-gradient(circle at 80% 30%, rgba(56,189,248,0.9) 0, transparent 60%),
        radial-gradient(circle at 30% 80%, rgba(244,114,182,0.9) 0, transparent 60%);
      opacity: 0;
    }

    #fireworkOverlay.show::before {
      top: 30%;
      left: 20%;
      animation: fireworkCircle 0.8s ease-out forwards;
    }

    #fireworkOverlay.show::after {
      top: 60%;
      right: 15%;
      animation: fireworkCircle 0.8s ease-out forwards 0.1s;
    }

    @keyframes fireworkOverlayFade {
      0% { opacity: 0; }
      20% { opacity: 1; }
      100% { opacity: 0; }
    }

    @keyframes fireworkCircle {
      0% {
        transform: scale(0.3);
        opacity: 1;
      }
      100% {
        transform: scale(1.6);
        opacity: 0;
      }
    }

    /* === EMOJI POP EFFECT === */
    .emoji-pop {
      position: fixed;
      z-index: 2000;
      font-size: 1.6rem;
      pointer-events: none;
      animation: emojiPop 0.8s ease-out forwards;
    }

    @keyframes emojiPop {
      0% {
        transform: translate(-50%, 0) scale(0.7);
        opacity: 1;
      }
      70% {
        transform: translate(-50%, -30px) scale(1.1);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50px) scale(0.9);
        opacity: 0;
      }
    }

    /* === CLOCK STYLE (theme-aware) === */
    .clock-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    .clock-display {
  padding: 6px 18px;
  border-radius: 999px;

  /* Solid dark pill that works with all themes */
  background:
    radial-gradient(circle at 10% 0, rgba(255, 255, 255, 0), transparent 55%),
    #181a2500;

  border: 1px solid rgba(0, 0, 0, 0.11);

  /* Text follows theme accent */
  color: var(--accent);

  font-family: 'Share Tech Mono', monospace;
  font-size: 1.1rem;
  letter-spacing: 0.08em;
  min-width: 135px;
  text-align: center;
  text-shadow: 0 0 6px rgba(0, 0, 0, 0.182);
}

  </style>
</head>
<body>
  <div class="container py-4">

    <!-- Header + Live Clock + User Guide -->
    <div class="d-flex flex-wrap justify-content-between align-items-start mb-3">
      <div class="me-3">
        <h1 class="mb-2 text-uppercase">Work Time Calculator (Sun ‚Üí Thu)</h1>
        <button type="button"
                class="btn btn-outline-info btn-sm"
                data-bs-toggle="modal"
                data-bs-target="#userGuideModal">
          User Guide
        </button>
      </div>
      <div class="clock-wrapper mt-3 mt-sm-0">
        <div id="liveClock" class="clock-display"></div>
      </div>
    </div>

    <div id="cards" class="row g-3"></div>

    <!-- Analytics Dashboard -->
    <div class="card mt-4" id="analyticsCard">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>üìä Analytics Dashboard</span>
        <button class="btn btn-link day-toggle" type="button"
                data-bs-toggle="collapse" data-bs-target="#analytics-collapse"
                aria-expanded="false" aria-controls="analytics-collapse">
          Toggle
        </button>
      </div>
      <div id="analytics-collapse" class="collapse">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="hint-box">
                <div class="hint-title">Average Daily Hours</div>
                <div class="hint-value hint-value-strong" id="avgDailyHours">--</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="hint-box">
                <div class="hint-title">Most Productive Day</div>
                <div class="hint-value hint-value-strong" id="mostProductiveDay">--</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="hint-box">
                <div class="hint-title">Consistency Score</div>
                <div class="hint-value hint-value-strong" id="consistencyScore">--</div>
              </div>
            </div>
          </div>
          <div class="hint-box mt-3">
            <div class="hint-title">Insights & Recommendations</div>
            <div id="analyticsInsights" class="small">
              <p class="mb-1">Fill in your work hours to see personalized insights.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Monthly History -->
    <div class="card mt-4" id="monthlyHistoryCard">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>üìÖ Monthly History</span>
        <button class="btn btn-link day-toggle" type="button"
                data-bs-toggle="collapse" data-bs-target="#history-collapse"
                aria-expanded="false" aria-controls="history-collapse">
          Toggle
        </button>
      </div>
      <div id="history-collapse" class="collapse">
        <div class="card-body">
          <div id="weekSelector" class="mb-3">
            <label for="weekSelect" class="form-label small">Select Week</label>
            <select id="weekSelect" class="form-select form-select-sm">
              <option value="current">Current Week</option>
            </select>
          </div>
          <div id="weekHistoryDisplay">
            <p class="text-muted small">No historical data available. Complete and reset weeks to build history.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Goal Streaks -->
    <div class="card mt-4" id="streaksCard">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>üî• Goal Streaks</span>
        <button class="btn btn-link day-toggle" type="button"
                data-bs-toggle="collapse" data-bs-target="#streaks-collapse"
                aria-expanded="false" aria-controls="streaks-collapse">
          Toggle
        </button>
      </div>
      <div id="streaks-collapse" class="collapse">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="hint-box">
                <div class="hint-title">Current Streak</div>
                <div class="hint-value hint-value-strong" id="currentStreak">0 days</div>
                <div class="hint-subtle">Consecutive days meeting target</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="hint-box">
                <div class="hint-title">Best Streak</div>
                <div class="hint-value hint-value-strong" id="bestStreak">0 days</div>
                <div class="hint-subtle">Longest streak ever</div>
              </div>
            </div>
          </div>
          <div class="hint-box mt-3">
            <div class="hint-title">This Week's Progress</div>
            <div id="weeklyStreakDisplay" class="d-flex gap-2 mt-2">
              <!-- Dynamic streak indicators will be inserted here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex flex-wrap justify-content-between align-items-center mt-4">
      <div class="d-flex gap-2 mb-2 mb-sm-0">
        <span id="totalWorked" class="pill" title="Total time you have worked this week."></span>
        <span id="weeklyStatus" class="pill"
              title="If you see ‚ÄòOver by X‚Äô, it means you have worked X minutes more than the weekly target. If it says ‚ÄòX left‚Äô, that‚Äôs how many minutes you still need to work."></span>
        <span id="todayPlan" class="pill"
              title="Shows how much you should work on the next unfilled day to stay on track with the weekly target."></span>
      </div>
      <button id="resetBtn" class="btn btn-outline-light btn-sm theme-btn">Reset Week</button>
    </div>
  </div>

  <!-- Floating Settings Gear (Dropdown) -->
  <div class="dropdown">
    <button class="btn btn-outline-light btn-sm theme-btn floating-settings dropdown-toggle"
            type="button"
            id="settingsDropdown"
            data-bs-toggle="dropdown"
            aria-expanded="false">
      ‚öôÔ∏è
    </button>

    <div class="dropdown-menu dropdown-menu-end p-3"
         aria-labelledby="settingsDropdown"
         style="min-width: 240px; background: var(--card); color: var(--text); border: 1px solid rgba(255,255,255,0.15);">
      <label for="themeSelect" class="form-label mb-1">Theme</label>
      <select id="themeSelect" class="form-select mb-3">
        <option value="auto">Auto (System)</option>
        <option value="cyberDark">Cyber Dark</option>
        <option value="neonBlue">Neon Blue</option>
        <option value="matrixGreen">Matrix Green</option>
        <option value="sunsetOrange">Sunset Orange</option>
        <option value="minimalLight">Minimal Light</option>
        <option value="redTheme">Red Theme</option>
        <option value="pinkTheme">Pink Theme</option>
      </select>

      <label for="modeSelect" class="form-label mb-1">Mode</label>
      <select id="modeSelect" class="form-select mb-3">
        <option value="normal">Normal</option>
        <option value="ramadan">Ramadan</option>
      </select>

      <label for="fontSelect" class="form-label mb-1">Font</label>
      <select id="fontSelect" class="form-select mb-3">
        <option value="Orbitron">Orbitron</option>
        <option value="Share Tech Mono">Share Tech Mono</option>
        <option value="Audiowide">Audiowide</option>
        <option value="Roboto">Roboto</option>
        <option value="Courier New">Courier New</option>
        <option value="Comic Sans MS">Comic Sans</option>
      </select>
      
      <hr class="my-3" style="border-color: rgba(255,255,255,0.15);">
      
      <label class="form-label mb-2">Work-Life Balance</label>
      
      <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" id="enableNotifications">
        <label class="form-check-label" for="enableNotifications">
          Enable Reminders
        </label>
      </div>
      
      <label for="breakIntervalSelect" class="form-label mb-1 small">Break Reminder Interval</label>
      <select id="breakIntervalSelect" class="form-select form-select-sm mb-2">
        <option value="30">Every 30 minutes</option>
        <option value="60" selected>Every 60 minutes</option>
        <option value="90">Every 90 minutes</option>
        <option value="120">Every 2 hours</option>
      </select>
      
      <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" id="enableEndOfDayNotification" checked>
        <label class="form-check-label small" for="enableEndOfDayNotification">
          End of day target reminder
        </label>
      </div>
      
      <hr class="my-3" style="border-color: rgba(255,255,255,0.15);">
      
      <label class="form-label mb-2">Data Management</label>
      <div class="d-grid gap-2">
        <button id="exportDataBtn" class="btn btn-outline-light btn-sm theme-btn">
          üì• Export Data
        </button>
        <button id="importDataBtn" class="btn btn-outline-light btn-sm theme-btn">
          üì§ Import Data
        </button>
        <input type="file" id="importFileInput" accept=".json" style="display: none;">
      </div>
    </div>
  </div>

  <!-- Full-page Firework Overlay -->
  <div id="fireworkOverlay"></div>

  <!-- User Guide Modal -->
  <div class="modal fade" id="userGuideModal" tabindex="-1" aria-labelledby="userGuideLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content" style="background:var(--card);color:var(--text);">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="userGuideLabel">How to use the Work Time Calculator</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-3">
            This tool helps you track your working hours from <strong>Sunday to Thursday</strong>.
            Each day‚Äôs target is your configured daily hours, and the weekly target is 5 √ó that.
          </p>

          <h6 class="mt-3">1. Basic idea</h6>
          <ul>
            <li>Each day = <strong>daily target</strong>, week = <strong>5 √ó daily target</strong>.</li>
            <li>You can either:
              <ul>
                <li>Enter <strong>Entry</strong> and <strong>Leave</strong> times, or</li>
                <li>Enter a <strong>total duration</strong> directly (e.g. 08:15).</li>
              </ul>
            </li>
            <li>Any extra or missing minutes are carried over to the next days automatically.</li>
            <li>Your data is stored locally in your browser (localStorage).</li>
          </ul>

          <h6 class="mt-3">2. Flex time rules</h6>
          <ul>
            <li>If you arrive between <strong>09:00 and 09:15</strong>, it is counted as <strong>09:00</strong>.</li>
            <li>Anything before <strong>07:00</strong> is treated as if you started at <strong>07:00</strong>.</li>
            <li>Each day is capped at <strong>9 hours</strong>, even if you stay longer.</li>
          </ul>

          <h6 class="mt-3">3. Example: rolling balance</h6>
          <p>Example for how extra time and deficits roll over between days:</p>
          <ol>
            <li>
              <strong>Sunday:</strong> You work from <strong>07:00 to 15:10</strong> ‚Üí that‚Äôs
              <strong>8h 10m</strong>, so you are <strong>+10 minutes</strong>.
            </li>
            <li class="mt-2">
              <strong>Monday:</strong> Because of the +10 minutes from Sunday, your target becomes
              <strong>7h 50m</strong> instead of 8h.
            </li>
          </ol>

          <h6 class="mt-3">4. What each part of the card means</h6>
          <ul>
            <li><strong>Entry / Leave</strong>: your start and end times for the day.</li>
            <li><strong>Or total work (hh:mm)</strong>: if you just know the total hours, enter it here instead.</li>
            <li><strong>Hint box</strong>:
              <ul>
                <li><em>Today plan</em>: tells you how much you should work to stay on track.</li>
                <li><em>Today summary</em>: once you‚Äôve worked, shows your actual time vs target (capped at 9h).</li>
              </ul>
            </li>
            <li><strong>Small progress bar</strong>: shows your progress towards the daily target.</li>
          </ul>

          <h6 class="mt-3">5. Weekly summary pills</h6>
          <ul>
            <li><strong>Total</strong>: how much you worked in total this week.</li>
            <li><strong>X left / Over by X</strong>: how far you are from the weekly target.</li>
            <li><strong>Today plan</strong>: how much you should work on the next unfilled day.</li>
          </ul>

          <p class="mt-3 mb-0 small text-muted">
            Tip: You can change the theme, mode (Normal/Ramadan), and font at any time. All your inputs and preferences are saved in your browser.
          </p>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday"];

    const DAY_MAX = 9*60;          // 9 hours cap

    const MODES = {
      normal:  { label: 'Normal',  dailyHours: 8 }, // 8h/day
      ramadan: { label: 'Ramadan', dailyHours: 6 }  // 6h/day
    };

    const MODE_KEY = 'workTimeCalculatorMode';

    let currentMode   = 'normal';
    let TARGET_PER_DAY = MODES[currentMode].dailyHours * 60;
    let WEEKLY_TARGET  = 5 * TARGET_PER_DAY;

    const STORAGE_KEY = 'workTimeCalculator';
    const THEME_KEY   = 'workTimeCalculatorTheme';
    const FONT_KEY    = 'workTimeCalculatorFont';
    const MONTHLY_HISTORY_KEY = 'workTimeCalculatorMonthlyHistory';
    const STREAKS_KEY = 'workTimeCalculatorStreaks';
    const NOTIFICATIONS_KEY = 'workTimeCalculatorNotifications';

    const elCards = document.getElementById('cards');

    function buildSelect(idPrefix,label){
      return `
        <div class="mb-3">
          <label class="form-label">${label}</label>
          <div class="d-flex gap-2">
            <select id="${idPrefix}-hour" class="form-select">
              ${Array.from({length:24},(_,h)=>`<option value="${String(h).padStart(2,'0')}">${String(h).padStart(2,'0')}</option>`).join('')}
            </select>
            <select id="${idPrefix}-min" class="form-select">
              ${Array.from({length:60},(_,m)=>`<option value="${String(m).padStart(2,'0')}">${String(m).padStart(2,'0')}</option>`).join('')}
            </select>
          </div>
        </div>`;
    }

    // Build cards with accordion-style collapse and day delta pill
    days.forEach(d => {
      const id = d.toLowerCase();
      const col = document.createElement('div');
      col.className = 'col-12'; // 1 card per row on all devices
      const isFirst = d === "Sunday";
      col.innerHTML = `
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex flex-column">
              <button class="btn btn-link day-toggle text-start flex-grow-1" type="button"
                      data-bs-toggle="collapse" data-bs-target="#${id}-collapse"
                      aria-expanded="${isFirst ? 'true' : 'false'}" aria-controls="${id}-collapse">
                ${d}
              </button>
              <span id="${id}-delta"
                    class="pill mt-1"
                    title="Difference from the daily target for this day, after considering earlier days."></span>
            </div>
            <div class="btn-group btn-group-sm ms-2">
              <button class="btn btn-outline-light entry-btn theme-btn" data-day="${id}">Entry Now</button>
              <button class="btn btn-outline-light leave-btn theme-btn" data-day="${id}">Leave Now</button>
            </div>
          </div>
          <div id="${id}-collapse" class="collapse ${isFirst ? 'show' : ''}" data-bs-parent="#cards">
            <div class="card-body">
              ${buildSelect(id+"-in","Entry")}
              ${buildSelect(id+"-out","Leave")}
              ${buildSelect(id+"-dur","Or total work (hh:mm)")}

              <div class="d-flex flex-wrap gap-2 mb-2">
                <button class="btn btn-outline-light btn-sm theme-btn full-day-btn" data-day="${id}">
                  Full day
                </button>
                <button class="btn btn-outline-light btn-sm theme-btn reset-day-btn" data-day="${id}">
                  Reset Day
                </button>
              </div>

              <div class="small" id="${id}-hint"
                   title="‚ÄòYou can work X today‚Äô tells you how much you should work today so your weekly total stays on track."></div>
              <div class="progress mt-2" style="height:6px;">
                <div class="progress-bar" id="${id}-progress" role="progressbar"
                     aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
              </div>
            </div>
          </div>
        </div>
      `;
      elCards.appendChild(col);
    });

    function setNow(prefix, type){
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');

      document.getElementById(`${prefix}-${type}-hour`).value = hh;
      document.getElementById(`${prefix}-${type}-min`).value = mm;

      saveData();
      recalc();
    }

    // Emoji spawn near click
    const EMOJIS = ["‚ú®","üî•","üíº","‚è∞","‚ö°","üéâ"];

    function spawnEmojiAt(x, y) {
      const emoji = document.createElement("span");
      emoji.className = "emoji-pop";
      emoji.textContent = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
      emoji.style.left = x + "px";
      emoji.style.top  = y + "px";
      document.body.appendChild(emoji);
      setTimeout(() => {
        emoji.remove();
      }, 900);
    }

    document.querySelectorAll('.entry-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const day = btn.dataset.day;
        spawnEmojiAt(e.clientX, e.clientY);
        setNow(day, "in");
      });
    });

    document.querySelectorAll('.leave-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const day = btn.dataset.day;
        setNow(day, "out");
      });
    });

    // Quick preset: Full day (uses current mode's TARGET_PER_DAY)
    document.querySelectorAll('.full-day-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const day = btn.dataset.day;

        const totalMinutes = TARGET_PER_DAY;
        const h = Math.floor(totalMinutes / 60);
        const m = totalMinutes % 60;

        document.getElementById(`${day}-dur-hour`).value = String(h).padStart(2, '0');
        document.getElementById(`${day}-dur-min`).value  = String(m).padStart(2, '0');

        document.getElementById(`${day}-in-hour`).value  = "00";
        document.getElementById(`${day}-in-min`).value   = "00";
        document.getElementById(`${day}-out-hour`).value = "00";
        document.getElementById(`${day}-out-min`).value  = "00";

        saveData();
        recalc();
      });
    });

    const selects = Array.from(document.querySelectorAll('select'));

    function loadData() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          selects.forEach(sel => { if (data[sel.id]) sel.value = data[sel.id]; });
        }
      } catch (error) { console.log('Error loading saved data:', error); }
    }
    function saveData() {
      try {
        const data = {};
        selects.forEach(sel => { data[sel.id] = sel.value; });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (error) { console.log('Error saving data:', error); }
    }
    function clearData() { localStorage.removeItem(STORAGE_KEY); }

    selects.forEach(sel => sel.addEventListener('change', () => { saveData(); recalc(); }));
    document.getElementById('resetBtn').addEventListener('click', () => {
      try {
        saveWeekToHistory();
      } catch (error) {
        console.log('Error saving week to history:', error);
      }
      selects.forEach(s => s.selectedIndex=0);
      clearData(); 
      recalc();
      loadMonthlyHistory();
    });

    function toMin(hhmm){ if(!hhmm) return null; const [h,m]=hhmm.split(':').map(Number); return h*60+m; }
    function minToHM(mins){
      const sign=mins<0?'-':'';
      const a=Math.abs(mins);
      return `${sign}${Math.floor(a/60)}h ${a%60}m`;
    }
    function minsToHMNoSign(mins){
      const a=Math.abs(mins);
      return `${Math.floor(a/60)}h ${a%60}m`;
    }

    function addMinutes(hhmm,delta){
      const m=toMin(hhmm);
      if(m==null)return null;
      let t=m+delta;
      const dayChange=Math.floor(t/(24*60));
      t=((t%(24*60))+(24*60))%(24*60);
      return {
        time:`${String(Math.floor(t/60)).padStart(2,'0')}:${String(t%60).padStart(2,'0')}`,
        dayChange
      };
    }

    // Reset specific day
    document.querySelectorAll('.reset-day-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const day = btn.dataset.day;

        document.getElementById(`${day}-in-hour`).value = "00";
        document.getElementById(`${day}-in-min`).value = "00";
        document.getElementById(`${day}-out-hour`).value = "00";
        document.getElementById(`${day}-out-min`).value = "00";
        document.getElementById(`${day}-dur-hour`).value = "00";
        document.getElementById(`${day}-dur-min`).value = "00";

        saveData();
        recalc();
      });
    });

    // Flex start: before 07:00 ‚Üí 07:00, 09:00‚Äì09:15 ‚Üí 09:00
    function flexStart(hhmm){
      if(!hhmm) return hhmm;
      const m = toMin(hhmm);
      const seven = 7*60;
      const nine = 9*60, nineFifteen = 9*60 + 15;
      if (m < seven) return "07:00";
      if (m >= nine && m <= nineFifteen) return "09:00";
      return hhmm;
    }

    function getValue(prefix){
      const h=document.getElementById(prefix+"-hour").value;
      const m=document.getElementById(prefix+"-min").value;
      return `${h}:${m}`;
    }

    function getWorked(prefix){
      const dur=getValue(prefix+"-dur");
      if(dur!=="00:00"){
        const mins = toMin(dur);
        if (mins == null) return null;
        return Math.min(mins, DAY_MAX);
      }
      const tin=getValue(prefix+"-in");
      const tout=getValue(prefix+"-out");
      if(tin!=="00:00" && tout!=="00:00"){
        const mi = toMin(flexStart(tin));
        const mo = toMin(tout);
        if (mi == null || mo == null) return null;
        const raw = mo >= mi ? mo - mi : (24*60 - mi + mo);
        return Math.min(raw, DAY_MAX);
      }
      return null;
    }

    function bumpPill(el){
      if(!el) return;
      el.classList.remove('pill-bump');
      void el.offsetWidth;
      el.classList.add('pill-bump');
    }

    function bumpProgress(el) {
      if (!el) return;
      el.classList.remove('progress-firework');
      void el.offsetWidth;
      el.classList.add('progress-firework');
    }

    // Full page firework trigger
    function triggerFirework() {
      const overlay = document.getElementById('fireworkOverlay');
      if (!overlay) return;
      overlay.classList.remove('show');
      void overlay.offsetWidth;
      overlay.classList.add('show');
      setTimeout(() => {
        overlay.classList.remove('show');
      }, 900);
    }

    // Track last worked values to detect "day just filled"
    let lastWorked = new Array(days.length).fill(null);

    function recalc(){
      const worked=[];
      days.forEach(d=>{worked.push(getWorked(d.toLowerCase()));});

      const justFilled = worked.map((w, idx) =>
        lastWorked[idx] == null && w != null
      );

      const baseDiffs = worked.map(w => (w == null ? null : w - TARGET_PER_DAY));
      const adjustedDiffs = baseDiffs.slice();

      // Pass 1: earlier positive days cover later negative days
      for (let j = 0; j < adjustedDiffs.length; j++) {
        if (adjustedDiffs[j] != null && adjustedDiffs[j] < 0) {
          let deficit = -adjustedDiffs[j];
          for (let k = 0; k < j; k++) {
            if (adjustedDiffs[k] != null && adjustedDiffs[k] > 0) {
              const use = Math.min(adjustedDiffs[k], deficit);
              adjustedDiffs[k] -= use;
              deficit -= use;
              if (deficit === 0) break;
            }
          }
          adjustedDiffs[j] = deficit === 0 ? 0 : -deficit;
        }
      }

      // Pass 2: later positive days cover earlier negative days
      for (let j = adjustedDiffs.length - 1; j >= 0; j--) {
        if (adjustedDiffs[j] != null && adjustedDiffs[j] > 0) {
          let surplus = adjustedDiffs[j];
          for (let k = j - 1; k >= 0; k--) {
            if (adjustedDiffs[k] != null && adjustedDiffs[k] < 0) {
              const use = Math.min(surplus, -adjustedDiffs[k]);
              adjustedDiffs[k] += use;
              surplus -= use;
              if (surplus === 0) break;
            }
          }
          adjustedDiffs[j] = surplus;
        }
      }

      days.forEach((d,idx)=>{
        const prefix=d.toLowerCase();
        const hint=document.getElementById(`${prefix}-hint`);
        const progressBar=document.getElementById(`${prefix}-progress`);
        const deltaEl=document.getElementById(`${prefix}-delta`);
        const entry=getValue(prefix+"-in");
        const w=worked[idx];

        const plannedBefore=idx*TARGET_PER_DAY;
        const actualBefore=worked.slice(0,idx).reduce((a,b)=>a+(b||0),0);
        const balance=actualBefore-plannedBefore;
        let target=TARGET_PER_DAY-balance;
        if(target<0) target=0;

        if (w != null) {
          const diff = w - TARGET_PER_DAY;
          const targetHours = TARGET_PER_DAY / 60;
          const diffLabel =
            diff === 0
              ? `Exact ${targetHours}h`
              : diff > 0
                ? `+${minsToHMNoSign(diff)} vs ${targetHours}h`
                : `-${minsToHMNoSign(-diff)} vs ${targetHours}h`;

          hint.innerHTML = `
            <div class="hint-box">
              <div class="hint-title">Today summary</div>
              <div class="hint-row">
                <span class="hint-label">Worked</span>
                <span class="hint-value hint-value-strong">${minToHM(w)}</span>
              </div>
              <div class="hint-row">
                <span class="hint-label">Compared to daily target</span>
                <span class="hint-value">${diffLabel}</span>
              </div>
              <div class="hint-subtle">
                Capped at 9h even if you stayed longer.
              </div>
            </div>
          `;
          hint.title = "This is your actual worked time for this day (capped at 9 hours).";

          const ratio = Math.min(w / TARGET_PER_DAY, 1);
          progressBar.style.width = `${ratio * 100}%`;
          progressBar.setAttribute('aria-valuenow', Math.round(ratio * 100));
        } else {
          const startForCalc = entry !== "00:00" ? flexStart(entry) : null;
          let leaveBlock = '';
          if (entry !== "00:00") {
            const res = addMinutes(startForCalc, target);
            if (res) {
              const shownStart =
                startForCalc !== entry
                  ? `${entry} ‚Üí <strong>${startForCalc}</strong>`
                  : `<strong>${startForCalc}</strong>`;
              leaveBlock = `
                <div class="hint-row">
                  <span class="hint-label">If you start at</span>
                  <span class="hint-value">${shownStart}</span>
                </div>
                <div class="hint-row">
                  <span class="hint-label">Leave by</span>
                  <span class="hint-value hint-value-strong">${res.time}${res.dayChange ? ` (+${res.dayChange}d)` : ''}</span>
                </div>
              `;
            }
          }

          hint.innerHTML = `
            <div class="hint-box">
              <div class="hint-title">Today plan</div>
              <div class="hint-row">
                <span class="hint-label">You can work</span>
                <span class="hint-value hint-value-strong">${minToHM(target)}</span>
              </div>
              ${leaveBlock}
            </div>
          `;
          hint.title = "‚ÄúYou can work X today‚Äù tells you how much to work today so your weekly total stays on track.";

          progressBar.style.width = `0%`;
          progressBar.setAttribute('aria-valuenow', 0);
        }

        const adjDiff = adjustedDiffs[idx];

        if (w == null || adjDiff == null) {
          deltaEl.textContent = '';
          deltaEl.className = 'pill mt-1';
        } 
        else if (adjDiff === 0) {
          deltaEl.textContent = 'Exact time';
          deltaEl.className = 'pill mt-1';
        } else if (adjDiff > 0) {
          deltaEl.textContent = `+${minsToHMNoSign(adjDiff)}`;
          deltaEl.className = 'pill good mt-1';
        } else {
          deltaEl.textContent = `-${minsToHMNoSign(-adjDiff)}`;
          deltaEl.className = 'pill bad mt-1';
        }

        if (worked[idx] == null) {
          deltaEl.style.visibility = "hidden";
        } else {
          deltaEl.style.visibility = "visible";
        }

        if (justFilled[idx]) {
          bumpProgress(progressBar);
          bumpPill(deltaEl);
        }
      });

      const total=worked.reduce((a,b)=>a+(b||0),0);
      const rem=WEEKLY_TARGET-total;
      const totalEl=document.getElementById('totalWorked');
      totalEl.textContent=`Total: ${minToHM(total)}`;
      bumpPill(totalEl);

      const status=document.getElementById('weeklyStatus');
      if(rem>0){
        status.className='pill warn';
        status.textContent=`${minToHM(rem)} left`;
      } else if(rem===0){
        status.className='pill good';
        status.textContent='Target met';
      } else {
        status.className='pill good';
        status.textContent=`Over by ${minToHM(-rem)}`;
      }
      bumpPill(status);

      const nextIdx=worked.findIndex(v=>v==null);
      const plan=document.getElementById('todayPlan');
      if(nextIdx>=0){
        const plannedBefore=nextIdx*TARGET_PER_DAY;
        const actualBefore=worked.slice(0,nextIdx).reduce((a,b)=>a+(b||0),0);
        let t=TARGET_PER_DAY-(actualBefore-plannedBefore);
        if(t<0) t=0;
        plan.textContent=`${days[nextIdx]} plan: ${minToHM(t)}`;
      } else {
        plan.textContent='All days filled';
      }
      bumpPill(plan);
      updateButtonsState();

      if (justFilled.some(Boolean)) {
        triggerFirework();
      }

      lastWorked = worked.slice();
      updateAnalytics(worked);
      updateStreaks();
    }

    function updateAnalytics(worked) {
      const filledDays = worked.filter(w => w != null);
      
      // Average Daily Hours
      const avgDailyEl = document.getElementById('avgDailyHours');
      if (filledDays.length > 0) {
        const avg = filledDays.reduce((a, b) => a + b, 0) / filledDays.length;
        avgDailyEl.textContent = minToHM(Math.round(avg));
      } else {
        avgDailyEl.textContent = '--';
      }
      
      // Most Productive Day
      const mostProductiveEl = document.getElementById('mostProductiveDay');
      if (filledDays.length > 0) {
        let maxIdx = -1;
        let maxWork = -1;
        worked.forEach((w, idx) => {
          if (w != null && w > maxWork) {
            maxWork = w;
            maxIdx = idx;
          }
        });
        if (maxIdx >= 0) {
          mostProductiveEl.textContent = `${days[maxIdx]} (${minToHM(maxWork)})`;
        } else {
          mostProductiveEl.textContent = '--';
        }
      } else {
        mostProductiveEl.textContent = '--';
      }
      
      // Consistency Score (based on how close each day is to target)
      const consistencyEl = document.getElementById('consistencyScore');
      if (filledDays.length > 0) {
        let totalDeviation = 0;
        filledDays.forEach(w => {
          totalDeviation += Math.abs(w - TARGET_PER_DAY);
        });
        const avgDeviation = totalDeviation / filledDays.length;
        // Score: 100% when avgDeviation is 0, decreasing as deviation increases
        const score = Math.max(0, Math.round(100 - (avgDeviation / TARGET_PER_DAY) * 100));
        consistencyEl.textContent = `${score}%`;
      } else {
        consistencyEl.textContent = '--';
      }
      
      // Insights & Recommendations
      const insightsEl = document.getElementById('analyticsInsights');
      if (filledDays.length === 0) {
        insightsEl.innerHTML = '<p class="mb-1">Fill in your work hours to see personalized insights.</p>';
      } else {
        let insights = [];
        
        // Check overshooting/undershooting
        const overshoots = [];
        const undershoots = [];
        worked.forEach((w, idx) => {
          if (w != null) {
            const diff = w - TARGET_PER_DAY;
            if (diff > 30) {
              overshoots.push(days[idx]);
            } else if (diff < -30) {
              undershoots.push(days[idx]);
            }
          }
        });
        
        if (overshoots.length > 0) {
          insights.push(`‚úÖ You exceeded targets on: <strong>${overshoots.join(', ')}</strong>`);
        }
        
        if (undershoots.length > 0) {
          insights.push(`‚ö†Ô∏è You were below target on: <strong>${undershoots.join(', ')}</strong>`);
        }
        
        // Consistency advice
        const avgDeviation = filledDays.reduce((sum, w) => sum + Math.abs(w - TARGET_PER_DAY), 0) / filledDays.length;
        if (avgDeviation < 30) {
          insights.push('üíØ Excellent consistency! You\'re maintaining steady work hours.');
        } else if (avgDeviation > 60) {
          insights.push('üìå Tip: Try to maintain more consistent daily hours for better work-life balance.');
        }
        
        // Weekly target progress
        const total = worked.reduce((a, b) => a + (b || 0), 0);
        const remaining = WEEKLY_TARGET - total;
        const unfilledDays = worked.filter(w => w == null).length;
        
        if (remaining > 0 && unfilledDays > 0) {
          const perDayNeeded = Math.ceil(remaining / unfilledDays);
          insights.push(`üéØ To meet weekly target: Work <strong>${minToHM(perDayNeeded)}</strong> per remaining day.`);
        } else if (remaining <= 0) {
          insights.push('üéâ Congratulations! You\'ve met or exceeded your weekly target.');
        }
        
        if (insights.length === 0) {
          insights.push('üìä Keep tracking your hours for more insights.');
        }
        
        insightsEl.innerHTML = insights.map(i => `<p class="mb-1">${i}</p>`).join('');
      }
    }

    function updateButtonsState() {
      days.forEach(d => {
        const id = d.toLowerCase();
        const entry = getValue(id + '-in');
        const leaveBtn = document.querySelector(`.leave-btn[data-day="${id}"]`);
        if (leaveBtn) {
          leaveBtn.disabled = (entry === '00:00');
        }
      });
    }

    const themes = {
      cyberDark: { "--bg":"#0f172a","--card":"#111827","--text":"#e5e7eb","--accent":"#22c55e","--warn":"#f59e0b","--error":"#ef4444","--muted":"#94a3b8","--select-bg":"#0b1220","--select-text":"#e5e7eb","--select-border":"#444" },
      neonBlue: { "--bg":"#001f3f","--card":"#003366","--text":"#7FDBFF","--accent":"#39CCCC","--warn":"#FFDC00","--error":"#FF4136","--muted":"#AAAAAA","--select-bg":"#002244","--select-text":"#7FDBFF","--select-border":"#39CCCC" },
      matrixGreen: { "--bg":"#000","--card":"#001a00","--text":"#00FF00","--accent":"#00cc66","--warn":"#cccc00","--error":"#ff3333","--muted":"#339933","--select-bg":"#002200","--select-text":"#00FF00","--select-border":"#00cc66" },
      sunsetOrange: { "--bg":"#2c0a0a","--card":"#661111","--text":"#ffcc99","--accent":"#ff6600","--warn":"#ffcc00","--error":"#ff3300","--muted":"#ff9966","--select-bg":"#441111","--select-text":"#ffcc99","--select-border":"#ff6600" },
      minimalLight: { "--bg":"#f9f9f9","--card":"#ffffff","--text":"#222","--accent":"#2e8b57","--warn":"#cc8800","--error":"#cc0000","--muted":"#666","--select-bg":"#ffffff","--select-text":"#222","--select-border":"#ccc" },
      redTheme: { "--bg":"#100000","--card":"#780000","--text":"#ffcccc","--accent":"#ff0000","--warn":"#ff6600","--error":"#cc0000","--muted":"#ff9999","--select-bg":"#330000","--select-text":"#ffcccc","--select-border":"#ff0000" },
      pinkTheme: { "--bg":"#ffd6e7","--card":"#ffe6f0","--text":"#5a3d47","--accent":"#ff80ab","--warn":"#ff5680","--error":"#ff4d6d","--muted":"#c48fb3","--select-bg":"#ffe6f0","--select-text":"#5a3d47","--select-border":"#ff80ab" }
    };

    const fontSelect = document.getElementById('fontSelect');
    fontSelect.addEventListener('change', e => {
      const chosenFont = e.target.value;
      document.documentElement.style.setProperty('--font', `'${chosenFont}', sans-serif`);
      localStorage.setItem(FONT_KEY, chosenFont);
    });

    const themeSelect = document.getElementById('themeSelect');
    
    function applyTheme(themeName) {
      let actualTheme = themeName;
      
      // Handle auto theme
      if (themeName === 'auto') {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        actualTheme = prefersDark ? 'cyberDark' : 'minimalLight';
      }
      
      const theme = themes[actualTheme];
      if (theme) {
        for(const key in theme){
          document.documentElement.style.setProperty(key, theme[key]);
        }
      }
    }
    
    themeSelect.addEventListener('change', e => {
      const themeName = e.target.value;
      applyTheme(themeName);
      localStorage.setItem(THEME_KEY, themeName);
    });
    
    // Listen for system theme changes when in auto mode
    const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    darkModeMediaQuery.addEventListener('change', () => {
      const currentTheme = localStorage.getItem(THEME_KEY);
      if (!currentTheme || currentTheme === 'auto') {
        applyTheme('auto');
      }
    });

    const modeSelect = document.getElementById('modeSelect');

    function applyMode(modeName) {
      if (!MODES[modeName]) modeName = 'normal';
      currentMode   = modeName;
      TARGET_PER_DAY = MODES[modeName].dailyHours * 60;
      WEEKLY_TARGET  = 5 * TARGET_PER_DAY;
      localStorage.setItem(MODE_KEY, modeName);
    }

    modeSelect.addEventListener('change', e => {
      const modeName = e.target.value;
      applyMode(modeName);
      recalc();
    });

    function loadPreferences(){
      const savedTheme = localStorage.getItem(THEME_KEY);
      const themeToLoad = savedTheme || 'auto';
      
      if(themeSelect){
        themeSelect.value = themeToLoad;
      }
      applyTheme(themeToLoad);

      const savedFont = localStorage.getItem(FONT_KEY);
      if(savedFont){
        fontSelect.value = savedFont;
        document.documentElement.style.setProperty('--font', `'${savedFont}', sans-serif`);
      }

      const savedMode = localStorage.getItem(MODE_KEY);
      const modeName  = savedMode && MODES[savedMode] ? savedMode : 'normal';
      if (modeSelect) {
        modeSelect.value = modeName;
      }
      applyMode(modeName);
    }

    function updateClock(){
      const el = document.getElementById('liveClock');
      if(!el) return;
      const now = new Date();
      const opts = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
      el.textContent = now.toLocaleTimeString([], opts);
    }

    // Hide gear when User Guide is open, show when closed
    document.addEventListener('DOMContentLoaded', () => {
      const userGuideModalEl = document.getElementById('userGuideModal');
      const settingsBtn = document.querySelector('.floating-settings');
      if (userGuideModalEl && settingsBtn) {
        userGuideModalEl.addEventListener('show.bs.modal', () => {
          settingsBtn.classList.add('d-none');
        });
        userGuideModalEl.addEventListener('hidden.bs.modal', () => {
          settingsBtn.classList.remove('d-none');
        });
      }
    });

    // === WORK-LIFE BALANCE NOTIFICATIONS ===
    let notificationInterval = null;
    let lastBreakNotification = Date.now();
    let lastEndOfDayCheck = null; // Track last date we checked for end of day
    
    function initNotifications() {
      const enableCheckbox = document.getElementById('enableNotifications');
      const breakIntervalSelect = document.getElementById('breakIntervalSelect');
      const endOfDayCheckbox = document.getElementById('enableEndOfDayNotification');
      
      // Load saved preferences
      const savedPrefs = loadNotificationPreferences();
      if (enableCheckbox) enableCheckbox.checked = savedPrefs.enabled;
      if (breakIntervalSelect) breakIntervalSelect.value = savedPrefs.breakInterval;
      if (endOfDayCheckbox) endOfDayCheckbox.checked = savedPrefs.endOfDay;
      
      // Request permission if enabled
      if (savedPrefs.enabled && 'Notification' in window) {
        if (Notification.permission === 'default') {
          Notification.requestPermission();
        }
      }
      
      // Event listeners
      if (enableCheckbox) {
        enableCheckbox.addEventListener('change', () => {
          const enabled = enableCheckbox.checked;
          saveNotificationPreferences();
          
          if (enabled) {
            requestNotificationPermission();
            startNotificationTimer();
          } else {
            stopNotificationTimer();
          }
        });
      }
      
      if (breakIntervalSelect) {
        breakIntervalSelect.addEventListener('change', () => {
          saveNotificationPreferences();
          if (enableCheckbox && enableCheckbox.checked) {
            stopNotificationTimer();
            startNotificationTimer();
          }
        });
      }
      
      if (endOfDayCheckbox) {
        endOfDayCheckbox.addEventListener('change', saveNotificationPreferences);
      }
      
      // Start timer if enabled
      if (savedPrefs.enabled) {
        startNotificationTimer();
      }
    }
    
    function loadNotificationPreferences() {
      try {
        const saved = localStorage.getItem(NOTIFICATIONS_KEY);
        if (saved) {
          return JSON.parse(saved);
        }
      } catch (error) {
        console.log('Error loading notification preferences:', error);
      }
      return {
        enabled: false,
        breakInterval: 60,
        endOfDay: true
      };
    }
    
    function saveNotificationPreferences() {
      const enableCheckbox = document.getElementById('enableNotifications');
      const breakIntervalSelect = document.getElementById('breakIntervalSelect');
      const endOfDayCheckbox = document.getElementById('enableEndOfDayNotification');
      
      const prefs = {
        enabled: enableCheckbox ? enableCheckbox.checked : false,
        breakInterval: breakIntervalSelect ? parseInt(breakIntervalSelect.value) : 60,
        endOfDay: endOfDayCheckbox ? endOfDayCheckbox.checked : true
      };
      
      try {
        localStorage.setItem(NOTIFICATIONS_KEY, JSON.stringify(prefs));
      } catch (error) {
        console.log('Error saving notification preferences:', error);
      }
    }
    
    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            showNotification('Notifications Enabled', '‚úÖ Work-life balance reminders are now active!');
          }
        });
      }
    }
    
    function showNotification(title, body) {
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
          body: body,
          tag: 'work-calc-notification'
        });
      }
    }
    
    function startNotificationTimer() {
      stopNotificationTimer(); // Clear any existing timer
      
      const prefs = loadNotificationPreferences();
      if (!prefs.enabled) return;
      
      const intervalMs = prefs.breakInterval * 60 * 1000;
      lastBreakNotification = Date.now();
      
      notificationInterval = setInterval(() => {
        checkAndSendNotifications();
      }, 60000); // Check every minute
    }
    
    function stopNotificationTimer() {
      if (notificationInterval) {
        clearInterval(notificationInterval);
        notificationInterval = null;
      }
    }
    
    function checkAndSendNotifications() {
      const prefs = loadNotificationPreferences();
      if (!prefs.enabled) return;
      
      const now = Date.now();
      const intervalMs = prefs.breakInterval * 60 * 1000;
      
      // Check if it's time for a break reminder
      if (now - lastBreakNotification >= intervalMs) {
        showNotification(
          'üßò Time for a Break!',
          `You've been working for ${prefs.breakInterval} minutes. Take a short break to refresh.`
        );
        lastBreakNotification = now;
      }
      
      // Check end of day notification (once per day between 17:00 and 17:05)
      if (prefs.endOfDay) {
        const currentDate = new Date();
        const currentHour = currentDate.getHours();
        const currentMinute = currentDate.getMinutes();
        const today = currentDate.toDateString();
        
        // Send notification between 17:00 and 17:05, but only once per day
        if (currentHour === 17 && currentMinute < 5 && lastEndOfDayCheck !== today) {
          const worked = [];
          days.forEach(d => { worked.push(getWorked(d.toLowerCase())); });
          const total = worked.reduce((a, b) => a + (b || 0), 0);
          const remaining = WEEKLY_TARGET - total;
          
          if (remaining > 0) {
            showNotification(
              'üìÖ End of Day Reminder',
              `You have ${minToHM(remaining)} remaining to meet your weekly target.`
            );
          } else {
            showNotification(
              'üéâ Great Work Today!',
              'You\'ve met your weekly target. Have a great evening!'
            );
          }
          
          lastEndOfDayCheck = today;
        }
      }
    }

    // === MONTHLY HISTORY FUNCTIONS ===
    function saveWeekToHistory() {
      const worked = [];
      days.forEach(d => { worked.push(getWorked(d.toLowerCase())); });
      
      // Only save if there's actual work data
      const hasData = worked.some(w => w != null && w > 0);
      if (!hasData) return;
      
      const weekData = {
        timestamp: Date.now(),
        date: new Date().toISOString(),
        weekLabel: getWeekLabel(),
        days: {},
        total: worked.reduce((a, b) => a + (b || 0), 0),
        target: WEEKLY_TARGET,
        mode: currentMode
      };
      
      // Save each day's data
      days.forEach((d, idx) => {
        if (worked[idx] != null) {
          weekData.days[d] = worked[idx];
        }
      });
      
      // Load existing history
      let history = [];
      try {
        const saved = localStorage.getItem(MONTHLY_HISTORY_KEY);
        if (saved) {
          history = JSON.parse(saved);
        }
      } catch (error) {
        console.log('Error loading history:', error);
      }
      
      // Add new week to history (limit to last 8 weeks per month)
      history.unshift(weekData);
      if (history.length > 8) {
        history = history.slice(0, 8);
      }
      
      try {
        localStorage.setItem(MONTHLY_HISTORY_KEY, JSON.stringify(history));
      } catch (error) {
        console.log('Error saving history:', error);
      }
    }
    
    function getWeekLabel() {
      const now = new Date();
      const weekNum = Math.ceil((now.getDate()) / 7);
      const monthName = now.toLocaleString('default', { month: 'short' });
      return `${monthName} Week ${weekNum}, ${now.getFullYear()}`;
    }
    
    function loadMonthlyHistory() {
      const weekSelect = document.getElementById('weekSelect');
      const displayDiv = document.getElementById('weekHistoryDisplay');
      
      if (!weekSelect || !displayDiv) return;
      
      try {
        const saved = localStorage.getItem(MONTHLY_HISTORY_KEY);
        if (!saved) {
          displayDiv.innerHTML = '<p class="text-muted small">No historical data available. Complete and reset weeks to build history.</p>';
          return;
        }
        
        const history = JSON.parse(saved);
        
        // Update select dropdown
        weekSelect.innerHTML = '<option value="current">Current Week</option>';
        history.forEach((week, idx) => {
          const option = document.createElement('option');
          option.value = idx;
          option.textContent = week.weekLabel;
          weekSelect.appendChild(option);
        });
        
        // Show current week by default
        displayCurrentWeek();
        
      } catch (error) {
        console.log('Error loading history:', error);
        displayDiv.innerHTML = '<p class="text-muted small text-danger">Error loading historical data.</p>';
      }
    }
    
    function displayCurrentWeek() {
      const displayDiv = document.getElementById('weekHistoryDisplay');
      if (!displayDiv) return;
      
      const worked = [];
      days.forEach(d => { worked.push(getWorked(d.toLowerCase())); });
      const total = worked.reduce((a, b) => a + (b || 0), 0);
      
      let html = '<div class="hint-box">';
      html += '<div class="hint-title">Current Week Progress</div>';
      
      days.forEach((d, idx) => {
        const w = worked[idx];
        if (w != null) {
          html += `<div class="hint-row">
            <span class="hint-label">${d}</span>
            <span class="hint-value">${minToHM(w)}</span>
          </div>`;
        }
      });
      
      html += `<div class="hint-row mt-2" style="border-top: 1px solid rgba(148,163,184,0.25); padding-top: 0.5rem;">
        <span class="hint-label hint-value-strong">Total</span>
        <span class="hint-value hint-value-strong">${minToHM(total)}</span>
      </div>`;
      html += '</div>';
      
      displayDiv.innerHTML = html;
    }
    
    function displayHistoricalWeek(weekIndex) {
      const displayDiv = document.getElementById('weekHistoryDisplay');
      if (!displayDiv) return;
      
      try {
        const saved = localStorage.getItem(MONTHLY_HISTORY_KEY);
        if (!saved) return;
        
        const history = JSON.parse(saved);
        const week = history[weekIndex];
        
        if (!week) return;
        
        let html = '<div class="hint-box">';
        html += `<div class="hint-title">${week.weekLabel}</div>`;
        
        days.forEach(d => {
          if (week.days[d] != null) {
            html += `<div class="hint-row">
              <span class="hint-label">${d}</span>
              <span class="hint-value">${minToHM(week.days[d])}</span>
            </div>`;
          }
        });
        
        html += `<div class="hint-row mt-2" style="border-top: 1px solid rgba(148,163,184,0.25); padding-top: 0.5rem;">
          <span class="hint-label hint-value-strong">Total</span>
          <span class="hint-value hint-value-strong">${minToHM(week.total)}</span>
        </div>`;
        html += `<div class="hint-row">
          <span class="hint-label">Target</span>
          <span class="hint-value">${minToHM(week.target)}</span>
        </div>`;
        
        const diff = week.total - week.target;
        const diffClass = diff >= 0 ? 'good' : 'bad';
        html += `<div class="hint-row">
          <span class="hint-label">Difference</span>
          <span class="hint-value ${diffClass}">${diff >= 0 ? '+' : ''}${minToHM(diff)}</span>
        </div>`;
        
        html += '</div>';
        displayDiv.innerHTML = html;
        
      } catch (error) {
        console.log('Error displaying week:', error);
      }
    }
    
    // Week selector change handler
    document.addEventListener('DOMContentLoaded', () => {
      const weekSelect = document.getElementById('weekSelect');
      if (weekSelect) {
        weekSelect.addEventListener('change', (e) => {
          if (e.target.value === 'current') {
            displayCurrentWeek();
          } else {
            displayHistoricalWeek(parseInt(e.target.value));
          }
        });
      }
    });

    // === GOAL STREAKS FUNCTIONS ===
    function loadStreaks() {
      try {
        const saved = localStorage.getItem(STREAKS_KEY);
        if (saved) {
          return JSON.parse(saved);
        }
      } catch (error) {
        console.log('Error loading streaks:', error);
      }
      return {
        currentStreak: 0,
        bestStreak: 0,
        lastCheckDate: null,
        dailyHistory: []
      };
    }
    
    function saveStreaks(streaks) {
      try {
        localStorage.setItem(STREAKS_KEY, JSON.stringify(streaks));
      } catch (error) {
        console.log('Error saving streaks:', error);
      }
    }
    
    function updateStreaks() {
      const worked = [];
      days.forEach(d => { worked.push(getWorked(d.toLowerCase())); });
      
      const streaks = loadStreaks();
      
      // Calculate current streak from the most recent filled day backwards
      let consecutiveDays = 0;
      for (let i = worked.length - 1; i >= 0; i--) {
        if (worked[i] != null) {
          const diff = worked[i] - TARGET_PER_DAY;
          // Consider it a success if within -30 minutes of target
          if (diff >= -30) {
            consecutiveDays++;
          } else {
            // Stop counting when we hit a day that missed the target
            break;
          }
        } else {
          // Stop at unfilled days
          break;
        }
      }
      
      // Update current streak
      streaks.currentStreak = consecutiveDays;
      
      // Update best streak
      if (streaks.currentStreak > streaks.bestStreak) {
        streaks.bestStreak = streaks.currentStreak;
      }
      
      saveStreaks(streaks);
      displayStreaks(streaks, worked);
    }
    
    function displayStreaks(streaks, worked) {
      const currentStreakEl = document.getElementById('currentStreak');
      const bestStreakEl = document.getElementById('bestStreak');
      const weeklyStreakDisplay = document.getElementById('weeklyStreakDisplay');
      
      if (currentStreakEl) {
        const dayText = streaks.currentStreak === 1 ? 'day' : 'days';
        currentStreakEl.textContent = `${streaks.currentStreak} ${dayText}`;
      }
      
      if (bestStreakEl) {
        const dayText = streaks.bestStreak === 1 ? 'day' : 'days';
        bestStreakEl.textContent = `${streaks.bestStreak} ${dayText}`;
      }
      
      if (weeklyStreakDisplay) {
        let html = '';
        days.forEach((d, idx) => {
          const w = worked[idx];
          let icon = '‚ö™'; // Not filled
          let title = 'No data';
          
          if (w != null) {
            const diff = w - TARGET_PER_DAY;
            if (diff >= -30) {
              icon = 'üî•'; // Met target
              title = `${d}: Target met`;
            } else {
              icon = '‚ùå'; // Missed target
              title = `${d}: Missed target`;
            }
          }
          
          html += `<span title="${title}" style="font-size: 1.5rem;">${icon}</span>`;
        });
        
        weeklyStreakDisplay.innerHTML = html;
      }
    }

    // === EXPORT/IMPORT FUNCTIONS ===
    function exportData() {
      const data = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        currentWeek: localStorage.getItem(STORAGE_KEY),
        history: localStorage.getItem(MONTHLY_HISTORY_KEY),
        streaks: localStorage.getItem(STREAKS_KEY),
        theme: localStorage.getItem(THEME_KEY),
        font: localStorage.getItem(FONT_KEY),
        mode: localStorage.getItem(MODE_KEY),
        notifications: localStorage.getItem(NOTIFICATIONS_KEY)
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `workcalc-data-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    function importData(fileContent) {
      try {
        const data = JSON.parse(fileContent);
        
        // Validate data structure
        if (!data.version) {
          alert('Invalid data format');
          return;
        }
        
        // Import all data
        if (data.currentWeek) localStorage.setItem(STORAGE_KEY, data.currentWeek);
        if (data.history) localStorage.setItem(MONTHLY_HISTORY_KEY, data.history);
        if (data.streaks) localStorage.setItem(STREAKS_KEY, data.streaks);
        if (data.theme) localStorage.setItem(THEME_KEY, data.theme);
        if (data.font) localStorage.setItem(FONT_KEY, data.font);
        if (data.mode) localStorage.setItem(MODE_KEY, data.mode);
        if (data.notifications) localStorage.setItem(NOTIFICATIONS_KEY, data.notifications);
        
        alert('Data imported successfully! Page will reload.');
        location.reload();
        
      } catch (error) {
        console.log('Error importing data:', error);
        alert('Error importing data. Please check the file format.');
      }
    }
    
    // Export/Import event listeners
    document.addEventListener('DOMContentLoaded', () => {
      const exportBtn = document.getElementById('exportDataBtn');
      const importBtn = document.getElementById('importDataBtn');
      const importInput = document.getElementById('importFileInput');
      
      if (exportBtn) {
        exportBtn.addEventListener('click', exportData);
      }
      
      if (importBtn && importInput) {
        importBtn.addEventListener('click', () => {
          importInput.click();
        });
        
        importInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              importData(event.target.result);
            };
            reader.readAsText(file);
          }
        });
      }
    });

    loadData();
    loadPreferences();
    recalc();
    updateClock();
    setInterval(updateClock, 1000);
    initNotifications();
    loadMonthlyHistory();
  </script>
</body>
</html>
