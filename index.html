<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Work Time Calculator — Sun→Thu</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Cyber fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&family=Share+Tech+Mono&family=Audiowide&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#0f172a; --card:#111827; --muted:#94a3b8;
      --accent:#22c55e; --warn:#f59e0b; --error:#ef4444; --text:#e5e7eb;
      --select-bg:#0b1220; --select-text:#e5e7eb; --select-border:#444;
      --font:'Roboto', sans-serif;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .card {
      background: var(--card);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.4s ease forwards;
    }
    .card-header {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .form-select {
      background: var(--select-bg);
      color: var(--select-text);
      border: 1px solid var(--select-border);
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    .pill {
      display:inline-block; padding:4px 10px; border-radius:999px;
      font-size:12px; border:1px solid rgba(148,163,184,0.2);
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
    }
    .good { color: var(--accent); border-color: rgba(34,197,94,0.4); }
    .warn { color: var(--warn); border-color: rgba(245,158,11,0.4); }
    .bad  { color: var(--error); border-color: rgba(239,68,68,0.4); }

    .pill-bump {
      animation: pillBump 0.25s ease;
    }

    .progress {
      background-color: rgba(148,163,184,0.25);
      transition: background-color 0.3s ease;
    }
    .progress-bar {
      background-color: var(--accent);
      transition: width 0.3s ease, background-color 0.3s ease;
    }

    .day-toggle.btn-link {
      color: inherit;
      text-decoration: none;
      padding-left: 0;
      padding-right: 0;
    }
    .day-toggle.btn-link:hover {
      text-decoration: underline;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @keyframes pillBump {
      0%   { transform: scale(1); }
      50%  { transform: scale(1.08); }
      100% { transform: scale(1); }
    }

    /* Hint box styling */
    .hint-box {
      margin-top: 0.35rem;
      padding: 0.55rem 0.75rem;
      border-radius: 0.75rem;
      background: rgba(148,163,184,0.08);
      border: 1px solid rgba(148,163,184,0.25);
      font-size: 0.8rem;
    }
    .hint-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 0.35rem;
    }
    .hint-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.1rem;
    }
    .hint-label {
      color: var(--muted);
    }
    .hint-value {
      font-weight: 500;
    }
    .hint-value-strong {
      font-weight: 600;
    }
    .hint-subtle {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 0.25rem;
    }
  </style>
</head>
<body>
  <div class="container py-4">

    <!-- Header + Live Clock + User Guide -->
    <div class="d-flex flex-wrap justify-content-between align-items-start mb-3">
      <div class="me-3">
        <h1 class="mb-2 text-uppercase">Work Time Calculator (Sun → Thu)</h1>
        <button type="button"
                class="btn btn-outline-info btn-sm"
                data-bs-toggle="modal"
                data-bs-target="#userGuideModal">
          User Guide
        </button>
      </div>
      <div class="d-flex flex-column align-items-end mt-3 mt-sm-0" style="gap:6px;">

  <div class="small text-uppercase text-muted text-end">Current time</div>
  <div id="liveClock" class="fs-4 fw-semibold"></div>

  <!-- Settings Dropdown -->
  <div class="dropdown">
    <button class="btn btn-outline-light btn-sm dropdown-toggle"
            type="button"
            id="settingsDropdown"
            data-bs-toggle="dropdown"
            aria-expanded="false">
      ⚙️ Settings
    </button>

    <div class="dropdown-menu dropdown-menu-end p-3"
         style="min-width: 240px; background: var(--card); color: var(--text); border: 1px solid rgba(255,255,255,0.15);">

      <label for="themeSelect" class="form-label mb-1">Theme</label>
      <select id="themeSelect" class="form-select mb-3">
        <option value="cyberDark">Cyber Dark</option>
        <option value="neonBlue">Neon Blue</option>
        <option value="matrixGreen">Matrix Green</option>
        <option value="sunsetOrange">Sunset Orange</option>
        <option value="minimalLight">Minimal Light</option>
        <option value="redTheme">Red Theme</option>
        <option value="pinkTheme">Pink Theme</option>
      </select>

      <label for="fontSelect" class="form-label mb-1">Font</label>
      <select id="fontSelect" class="form-select">
        <option value="Orbitron">Orbitron</option>
        <option value="Share Tech Mono">Share Tech Mono</option>
        <option value="Audiowide">Audiowide</option>
        <option value="Roboto">Roboto</option>
        <option value="Courier New">Courier New</option>
        <option value="Comic Sans MS">Comic Sans</option>
      </select>

    </div>
  </div>

</div>

    </div>

    

    <div id="cards" class="row g-3"></div>

    <div class="d-flex flex-wrap justify-content-between align-items-center mt-4">
      <div class="d-flex gap-2 mb-2 mb-sm-0">
        <span id="totalWorked" class="pill" title="Total time you have worked this week."></span>
        <span id="weeklyStatus" class="pill"
              title="If you see ‘Over by X’, it means you have worked X minutes more than the 40h weekly target. If it says ‘X left’, that’s how many minutes you still need to work."></span>
        <span id="todayPlan" class="pill"
              title="Shows how much you should work on the next unfilled day to stay on track with the weekly 40h target."></span>
      </div>
      <button id="resetBtn" class="btn btn-outline-light btn-sm">Reset Week</button>
    </div>
  </div>

  <!-- User Guide Modal -->
  <div class="modal fade" id="userGuideModal" tabindex="-1" aria-labelledby="userGuideLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content" style="background:var(--card);color:var(--text);">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="userGuideLabel">How to use the Work Time Calculator</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-3">
            This tool helps you track your working hours from <strong>Sunday to Thursday</strong>.
            Each day’s target is <strong>8 hours</strong>, so the weekly target is <strong>40 hours</strong>.
          </p>

          <h6 class="mt-3">1. Basic idea</h6>
          <ul>
            <li>Each day = <strong>8h</strong>, week = <strong>40h</strong>.</li>
            <li>You can either:
              <ul>
                <li>Enter <strong>Entry</strong> and <strong>Leave</strong> times, or</li>
                <li>Enter a <strong>total duration</strong> directly (e.g. 08:15).</li>
              </ul>
            </li>
            <li>Any extra or missing minutes are carried over to the next days automatically.</li>
            <li>Your data is stored locally in your browser (localStorage).</li>
          </ul>

          <h6 class="mt-3">2. Flex time rules</h6>
          <ul>
            <li>If you arrive between <strong>09:00 and 09:15</strong>, it is counted as <strong>09:00</strong>.</li>
            <li>Anything before <strong>07:00</strong> is treated as if you started at <strong>07:00</strong>.</li>
            <li>Each day is capped at <strong>9 hours</strong>, even if you stay longer.</li>
          </ul>

          <h6 class="mt-3">3. Example: rolling balance</h6>
          <p>Example for how extra time and deficits roll over between days:</p>
          <ol>
            <li>
              <strong>Sunday:</strong> You work from <strong>07:00 to 15:10</strong> → that’s
              <strong>8h 10m</strong>, so you are <strong>+10 minutes</strong>.
              <br>
              Sunday pill shows something like <code>+0h 10m</code>.
            </li>
            <li class="mt-2">
              <strong>Monday:</strong> Because of the +10 minutes from Sunday, your target becomes
              <strong>7h 50m</strong> instead of 8h.
              <ul>
                <li>If you work <strong>07:00 to 14:50</strong> (7h50):
                  <ul>
                    <li>Weekly total = exactly 16h → no extra and no deficit.</li>
                    <li>Both Sunday and Monday pills show <strong>Exact time</strong>.</li>
                  </ul>
                </li>
                <li>If you work <strong>07:00 to 14:55</strong> (7h55):
                  <ul>
                    <li>Weekly total = <strong>+5 minutes</strong>.</li>
                    <li>Sunday pill becomes <strong>+5</strong>, Monday becomes <strong>Exact time</strong>.</li>
                  </ul>
                </li>
                <li>If you work <strong>07:00 to 14:40</strong> (7h40):
                  <ul>
                    <li>Weekly total = <strong>-10 minutes</strong>.</li>
                    <li>Sunday pill becomes <strong>Exact time</strong>, Monday pill shows <strong>-10</strong>.</li>
                  </ul>
                </li>
              </ul>
            </li>
          </ol>

          <h6 class="mt-3">4. What each part of the card means</h6>
          <ul>
            <li><strong>Entry / Leave</strong>: your start and end times for the day.</li>
            <li><strong>Or total work (hh:mm)</strong>: if you just know the total hours, enter it here instead.</li>
            <li><strong>Hint box</strong>:
              <ul>
                <li><em>Today plan</em>: tells you how much you should work to stay on track, and suggests a leave time if you enter a start time.</li>
                <li><em>Today summary</em>: once you’ve worked, shows your actual time and how it compares to the 8h target (capped at 9h).</li>
              </ul>
            </li>
            <li><strong>Small progress bar</strong>: shows your progress towards the 8h goal for that day.</li>
            <li><strong>Day pill under the day name</strong>:
              <ul>
                <li><code>Exact time</code> → you’re exactly on the 8h target after considering earlier days.</li>
                <li><span class="text-success">+Xh Ym</span> → you’re ahead by that amount (green).</li>
                <li><span class="text-danger">-Xh Ym</span> → you’re behind by that amount (red).</li>
              </ul>
            </li>
          </ul>

          <h6 class="mt-3">5. Weekly summary pills</h6>
          <ul>
            <li><strong>Total</strong>: how much you worked in total this week.</li>
            <li><strong>X left / Over by X</strong>: how far you are from the 40h target.</li>
            <li><strong>Today plan</strong>: how much you should work on the next unfilled day.</li>
          </ul>

          <p class="mt-3 mb-0 small text-muted">
            Tip: You can change the theme and font at any time. All your inputs and preferences are saved in your browser.
          </p>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday"];
    const TARGET_PER_DAY = 8*60;   // 8 hours
    const DAY_MAX = 9*60;          // 9 hours cap
    const WEEKLY_TARGET = 5*TARGET_PER_DAY;

    const STORAGE_KEY = 'workTimeCalculator';
    const THEME_KEY   = 'workTimeCalculatorTheme';
    const FONT_KEY    = 'workTimeCalculatorFont';

    const elCards = document.getElementById('cards');

    function buildSelect(idPrefix,label){
      return `
        <div class="mb-3">
          <label class="form-label">${label}</label>
          <div class="d-flex gap-2">
            <select id="${idPrefix}-hour" class="form-select">
              ${Array.from({length:24},(_,h)=>`<option value="${String(h).padStart(2,'0')}">${String(h).padStart(2,'0')}</option>`).join('')}
            </select>
            <select id="${idPrefix}-min" class="form-select">
              ${Array.from({length:60},(_,m)=>`<option value="${String(m).padStart(2,'0')}">${String(m).padStart(2,'0')}</option>`).join('')}
            </select>
          </div>
        </div>`;
    }

    // Build cards with accordion-style collapse and day delta pill
    days.forEach(d => {
      const id = d.toLowerCase();
      const col = document.createElement('div');
      col.className = 'col-sm-6';
      const isFirst = d === "Sunday";
      col.innerHTML = `
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex flex-column">
              <button class="btn btn-link day-toggle text-start flex-grow-1" type="button"
                      data-bs-toggle="collapse" data-bs-target="#${id}-collapse"
                      aria-expanded="${isFirst ? 'true' : 'false'}" aria-controls="${id}-collapse">
                ${d}
              </button>
              <span id="${id}-delta"
                    class="pill mt-1"
                    title="Difference from the 8h target for this day, after considering earlier days."></span>
            </div>
            <div class="btn-group btn-group-sm ms-2">
              <button class="btn btn-outline-light entry-btn" data-day="${id}">Entry Now</button>
              <button class="btn btn-outline-light leave-btn" data-day="${id}">Leave Now</button>
            </div>
          </div>
          <div id="${id}-collapse" class="collapse ${isFirst ? 'show' : ''}" data-bs-parent="#cards">
            <div class="card-body">
              ${buildSelect(id+"-in","Entry")}
              ${buildSelect(id+"-out","Leave")}
              ${buildSelect(id+"-dur","Or total work (hh:mm)")}
              <div class="small" id="${id}-hint"
                   title="‘You can work X today’ tells you how much you should work today so your weekly total stays on track."></div>
              <div class="progress mt-2" style="height:6px;">
                <div class="progress-bar" id="${id}-progress" role="progressbar"
                     aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
              </div>
            </div>
          </div>
        </div>
      `;
      elCards.appendChild(col);
    });

    function setNow(prefix, type){
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');

      document.getElementById(`${prefix}-${type}-hour`).value = hh;
      document.getElementById(`${prefix}-${type}-min`).value = mm;

      saveData();
      recalc();
    }

    document.querySelectorAll('.entry-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const day = btn.dataset.day;
        setNow(day, "in");
      });
    });

    document.querySelectorAll('.leave-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const day = btn.dataset.day;
        setNow(day, "out");
      });
    });

    const selects = Array.from(document.querySelectorAll('select'));

    function loadData() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          selects.forEach(sel => { if (data[sel.id]) sel.value = data[sel.id]; });
        }
      } catch (error) { console.log('Error loading saved data:', error); }
    }
    function saveData() {
      try {
        const data = {};
        selects.forEach(sel => { data[sel.id] = sel.value; });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (error) { console.log('Error saving data:', error); }
    }
    function clearData() { localStorage.removeItem(STORAGE_KEY); }

    selects.forEach(sel => sel.addEventListener('change', () => { saveData(); recalc(); }));
    document.getElementById('resetBtn').addEventListener('click', () => {
      selects.forEach(s => s.selectedIndex=0);
      clearData(); recalc();
    });

    function toMin(hhmm){ if(!hhmm) return null; const [h,m]=hhmm.split(':').map(Number); return h*60+m; }
    function minToHM(mins){
      const sign=mins<0?'-':'';
      const a=Math.abs(mins);
      return `${sign}${Math.floor(a/60)}h ${a%60}m`;
    }
    // For the day diff pill (no automatic sign)
    function minsToHMNoSign(mins){
      const a=Math.abs(mins);
      return `${Math.floor(a/60)}h ${a%60}m`;
    }

    function addMinutes(hhmm,delta){
      const m=toMin(hhmm);
      if(m==null)return null;
      let t=m+delta;
      const dayChange=Math.floor(t/(24*60));
      t=((t%(24*60))+(24*60))%(24*60);
      return {
        time:`${String(Math.floor(t/60)).padStart(2,'0')}:${String(t%60).padStart(2,'0')}`,
        dayChange
      };
    }

    // Flex start: before 07:00 → 07:00, 09:00–09:15 → 09:00
    function flexStart(hhmm){
      if(!hhmm) return hhmm;
      const m = toMin(hhmm);
      const seven = 7*60;
      const nine = 9*60, nineFifteen = 9*60 + 15;
      if (m < seven) return "07:00";
      if (m >= nine && m <= nineFifteen) return "09:00";
      return hhmm;
    }

    function getValue(prefix){
      const h=document.getElementById(prefix+"-hour").value;
      const m=document.getElementById(prefix+"-min").value;
      return `${h}:${m}`;
    }

    function getWorked(prefix){
      const dur=getValue(prefix+"-dur");
      if(dur!=="00:00"){
        const mins = toMin(dur);
        if (mins == null) return null;
        // Cap at 9 hours max per day
        return Math.min(mins, DAY_MAX);
      }
      const tin=getValue(prefix+"-in");
      const tout=getValue(prefix+"-out");
      if(tin!=="00:00" && tout!=="00:00"){
        const mi = toMin(flexStart(tin));
        const mo = toMin(tout);
        if (mi == null || mo == null) return null;
        const raw = mo >= mi ? mo - mi : (24*60 - mi + mo);
        // Cap at 9 hours max per day
        return Math.min(raw, DAY_MAX);
      }
      return null;
    }

    function bumpPill(el){
      if(!el) return;
      el.classList.remove('pill-bump');
      // force reflow to restart animation
      void el.offsetWidth;
      el.classList.add('pill-bump');
    }

    function recalc(){
      const worked=[];
      days.forEach(d=>{worked.push(getWorked(d.toLowerCase()));});

      // Base difference from 8h for each worked day
      const baseDiffs = worked.map(w => (w == null ? null : w - TARGET_PER_DAY));
      // Copy to a mutable array we will adjust
      const adjustedDiffs = baseDiffs.slice();

      // Rule: earlier positive days cover later negative days
      for (let j = 0; j < adjustedDiffs.length; j++) {
        if (adjustedDiffs[j] != null && adjustedDiffs[j] < 0) {
          let deficit = -adjustedDiffs[j]; // minutes we need to cover
          for (let k = 0; k < j; k++) {
            if (adjustedDiffs[k] != null && adjustedDiffs[k] > 0) {
              const use = Math.min(adjustedDiffs[k], deficit);
              adjustedDiffs[k] -= use;   // consume from earlier surplus
              deficit -= use;
              if (deficit === 0) break;
            }
          }
          adjustedDiffs[j] = deficit === 0 ? 0 : -deficit;
        }
      }

      // Per-day calculations, hints, progress bars, and per-day diff pill
      days.forEach((d,idx)=>{
        const prefix=d.toLowerCase();
        const hint=document.getElementById(`${prefix}-hint`);
        const progressBar=document.getElementById(`${prefix}-progress`);
        const deltaEl=document.getElementById(`${prefix}-delta`);
        const entry=getValue(prefix+"-in");
        const w=worked[idx];

        const plannedBefore=idx*TARGET_PER_DAY;
        const actualBefore=worked.slice(0,idx).reduce((a,b)=>a+(b||0),0);
        const balance=actualBefore-plannedBefore;
        let target=TARGET_PER_DAY-balance;
        if(target<0) target=0;

        if (w != null) {
          // Day already has recorded work
          const diff = w - TARGET_PER_DAY;
          const diffLabel =
            diff === 0
              ? 'Exact 8h'
              : diff > 0
                ? `+${minsToHMNoSign(diff)} vs 8h`
                : `-${minsToHMNoSign(-diff)} vs 8h`;

          hint.innerHTML = `
            <div class="hint-box">
              <div class="hint-title">Today summary</div>
              <div class="hint-row">
                <span class="hint-label">Worked</span>
                <span class="hint-value hint-value-strong">${minToHM(w)}</span>
              </div>
              <div class="hint-row">
                <span class="hint-label">Compared to 8h</span>
                <span class="hint-value">${diffLabel}</span>
              </div>
              <div class="hint-subtle">
                Capped at 9h even if you stayed longer.
              </div>
            </div>
          `;
          hint.title = "This is your actual worked time for this day (capped at 9 hours).";

          const ratio = Math.min(w / TARGET_PER_DAY, 1);
          progressBar.style.width = `${ratio * 100}%`;
          progressBar.setAttribute('aria-valuenow', Math.round(ratio * 100));
        } else {
          // Planning mode (no worked time yet)
          const startForCalc = entry !== "00:00" ? flexStart(entry) : null;
          let leaveBlock = '';
          if (entry !== "00:00") {
            const res = addMinutes(startForCalc, target);
            if (res) {
              const shownStart =
                startForCalc !== entry
                  ? `${entry} → <strong>${startForCalc}</strong>`
                  : `<strong>${startForCalc}</strong>`;
              leaveBlock = `
                <div class="hint-row">
                  <span class="hint-label">If you start at</span>
                  <span class="hint-value">${shownStart}</span>
                </div>
                <div class="hint-row">
                  <span class="hint-label">Leave by</span>
                  <span class="hint-value hint-value-strong">${res.time}${res.dayChange ? ` (+${res.dayChange}d)` : ''}</span>
                </div>
              `;
            }
          }

          hint.innerHTML = `
            <div class="hint-box">
              <div class="hint-title">Today plan</div>
              <div class="hint-row">
                <span class="hint-label">You can work</span>
                <span class="hint-value hint-value-strong">${minToHM(target)}</span>
              </div>
              ${leaveBlock}
            </div>
          `;
          hint.title = "“You can work X today” tells you how much to work today so your weekly total stays on track.";

          progressBar.style.width = `0%`;
          progressBar.setAttribute('aria-valuenow', 0);
        }

        // Per-day diff pill vs 8h (dynamic, using earlier surplus to cover later deficit)
        const adjDiff = adjustedDiffs[idx];

        if (w == null || adjDiff == null) {
          deltaEl.textContent = '';
          deltaEl.className = 'pill mt-1';
        } else if (adjDiff === 0) {
          deltaEl.textContent = 'Exact time';
          deltaEl.className = 'pill mt-1';
        } else if (adjDiff > 0) {
          deltaEl.textContent = `+${minsToHMNoSign(adjDiff)}`;
          deltaEl.className = 'pill good mt-1';
        } else { // adjDiff < 0
          deltaEl.textContent = `-${minsToHMNoSign(-adjDiff)}`;
          deltaEl.className = 'pill bad mt-1';
        }
      });

      // Weekly totals
      const total=worked.reduce((a,b)=>a+(b||0),0);
      const rem=WEEKLY_TARGET-total;
      const totalEl=document.getElementById('totalWorked');
      totalEl.textContent=`Total: ${minToHM(total)}`;
      bumpPill(totalEl);

      const status=document.getElementById('weeklyStatus');
      if(rem>0){
        status.className='pill warn';
        status.textContent=`${minToHM(rem)} left`;
      } else if(rem===0){
        status.className='pill good';
        status.textContent='Target met';
      } else {
        status.className='pill good';
        status.textContent=`Over by ${minToHM(-rem)}`;
      }
      bumpPill(status);

      const nextIdx=worked.findIndex(v=>v==null);
      const plan=document.getElementById('todayPlan');
      if(nextIdx>=0){
        const plannedBefore=nextIdx*TARGET_PER_DAY;
        const actualBefore=worked.slice(0,nextIdx).reduce((a,b)=>a+(b||0),0);
        let t=TARGET_PER_DAY-(actualBefore-plannedBefore);
        if(t<0) t=0;
        plan.textContent=`${days[nextIdx]} plan: ${minToHM(t)}`;
      } else {
        plan.textContent='All days filled';
      }
      bumpPill(plan);
    }

    // Theme definitions
    const themes = {
      cyberDark: { "--bg":"#0f172a","--card":"#111827","--text":"#e5e7eb","--accent":"#22c55e","--warn":"#f59e0b","--error":"#ef4444","--muted":"#94a3b8","--select-bg":"#0b1220","--select-text":"#e5e7eb","--select-border":"#444" },
      neonBlue: { "--bg":"#001f3f","--card":"#003366","--text":"#7FDBFF","--accent":"#39CCCC","--warn":"#FFDC00","--error":"#FF4136","--muted":"#AAAAAA","--select-bg":"#002244","--select-text":"#7FDBFF","--select-border":"#39CCCC" },
      matrixGreen: { "--bg":"#000","--card":"#001a00","--text":"#00FF00","--accent":"#00cc66","--warn":"#cccc00","--error":"#ff3333","--muted":"#339933","--select-bg":"#002200","--select-text":"#00FF00","--select-border":"#00cc66" },
      sunsetOrange: { "--bg":"#2c0a0a","--card":"#661111","--text":"#ffcc99","--accent":"#ff6600","--warn":"#ffcc00","--error":"#ff3300","--muted":"#ff9966","--select-bg":"#441111","--select-text":"#ffcc99","--select-border":"#ff6600" },
      minimalLight: { "--bg":"#f9f9f9","--card":"#ffffff","--text":"#222","--accent":"#2e8b57","--warn":"#cc8800","--error":"#cc0000","--muted":"#666","--select-bg":"#ffffff","--select-text":"#222","--select-border":"#ccc" },
      redTheme: { "--bg":"#100000","--card":"#780000","--text":"#ffcccc","--accent":"#ff0000","--warn":"#ff6600","--error":"#cc0000","--muted":"#ff9999","--select-bg":"#330000","--select-text":"#ffcccc","--select-border":"#ff0000" },
      pinkTheme: { "--bg":"#ffd6e7","--card":"#ffe6f0","--text":"#5a3d47","--accent":"#ff80ab","--warn":"#ff5680","--error":"#ff4d6d","--muted":"#c48fb3","--select-bg":"#ffe6f0","--select-text":"#5a3d47","--select-border":"#ff80ab" }
    };

    // Font selector
    const fontSelect = document.getElementById('fontSelect');
    fontSelect.addEventListener('change', e => {
      const chosenFont = e.target.value;
      document.documentElement.style.setProperty('--font', `'${chosenFont}', sans-serif`);
      localStorage.setItem(FONT_KEY, chosenFont);
    });

    // Theme selector
    const themeSelect = document.getElementById('themeSelect');
    themeSelect.addEventListener('change', e => {
      const themeName = e.target.value;
      const theme = themes[themeName];
      for(const key in theme){
        document.documentElement.style.setProperty(key, theme[key]);
      }
      localStorage.setItem(THEME_KEY, themeName);
    });

    // Load saved theme & font
    function loadPreferences(){
      const savedTheme = localStorage.getItem(THEME_KEY);
      if(savedTheme && themes[savedTheme]){
        themeSelect.value = savedTheme;
        const theme = themes[savedTheme];
        for(const key in theme){
          document.documentElement.style.setProperty(key, theme[key]);
        }
      }

      const savedFont = localStorage.getItem(FONT_KEY);
      if(savedFont){
        fontSelect.value = savedFont;
        document.documentElement.style.setProperty('--font', `'${savedFont}', sans-serif`);
      }
    }

    // Live clock
    function updateClock(){
      const el = document.getElementById('liveClock');
      if(!el) return;
      const now = new Date();
      const opts = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
      el.textContent = now.toLocaleTimeString([], opts);
    }

    // Initialize
    loadData();
    loadPreferences();
    recalc();
    updateClock();
    setInterval(updateClock, 1000);
  </script>
</body>
</html>
